{% extends "navbar.html" %}
{% load static %}
{% block title %}PRACTICE{% endblock title %}

{% block body %}

<table class="table">
    <thead class="thead-default">
        <tr>
            <th>Item Id</th>
            <th>Image</th>
            <th>Item Group</th>
            <th>Item Description</th>
            <th>Item Rate</th>
            <th>Action</th>
        </tr>
    </thead>

    <tbody>
        <tr>
            <td></td>
            <td></td>
            <td><form method='GET' action='/practice' class="form-inline my-2 my-lg-0">{% csrf_token %}
                <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search" name="search" id="search" >
                <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>&nbsp;
              </form></td>
        </tr>
    {% for i in item %}
    <tr>
        <td>{{i.id}}</td>
        <td><img src="/media/{{i.image}}" width="100" height="100" ></td>
        <td>{{i.item_group}}</td>
        
        <td><h5 class="card-title" id="nameitem{{i.id}}">{{i.item_desc}}</h5></td>
        <td><span id="priceitem{{i.id}}">{{i.item_rate}}</span></td>
           <td> <button data-product="{{i.id}}" data-action="add" class="btn btn-outline-secondary add-btn update-cart"> Add to Ccart </button>
          </span></td>
           </tr>
  </tbody>
{%endfor%}

{% endblock body %}

{% block js %} 
 
<script>

  var user = '{{request.user}}'

  function getToken(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

var csrftoken = getToken('csrftoken');



var updateBtns = document.getElementsByClassName('update-cart');

for (var i = 0; i < updateBtns.length; i++){
  updateBtns[i].addEventListener('click', function(){ 
    var productId = this.dataset.product;
    var action = this.dataset.action;
    console.log('productId:', productId, 'action:', action)
    console.log('USER:', user )  
    if (user == 'AnonymousUser'){
      console.log('User is not authenticated')
    }else{
      updateUserOrder(productId, action)
    }

  });
}




function updateUserOrder(productId, action){
    var url = '/update_item/'
    console.log('URL:', url)
    fetch(`${window.location.origin}${url}`, {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'X-CSRFToken':csrftoken ,
      },
      body:JSON.stringify({'productId': productId, 'action':action})
    })
    .then((response) => {
      return response.json();
    })
    .then((data) => {
      console.log('data:', data)
      location.reload()
    });
  }



</script>

{% endblock %}



